


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Reconstructing virtual markers &mdash; Kinetics Toolkit (dev) master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "document", "processHtmlClass": "math|output_area"}}</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Wheelchair kinetics" href="../pushrimkinetics.html" />
    <link rel="prev" title="Calculating joint angles from a kinematic acquisition" href="joint_angles.html" />


 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo_development.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">GETTING STARTED</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../what_is_kinetics_toolkit.html">What is Kinetics Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timeseries.html">TimeSeries</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TUTORIALS</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../loadsave.html">Saving and loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters/filters.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cycles.html">Detecting and normalizing cycles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geometry/geometry.html">Rigid body geometry</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="kinematics.html">Kinematics analysis</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="load_visualize.html">Reading and visualizing marker trajectories</a></li>
<li class="toctree-l2"><a class="reference internal" href="joint_angles.html">Calculating joint angles from a kinematic acquisition</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Reconstructing virtual markers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Read-and-visualize-marker-trajectories">Read and visualize marker trajectories</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Calibration:-Defining-rigid-body-configurations-using-a-static-acquisition">Calibration: Defining rigid body configurations using a static acquisition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Calibration:-Defining-the-virtual-marker-configurations-based-on-probing-acquisitions">Calibration: Defining the virtual marker configurations based on probing acquisitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Task-analysis:-Tracking-the-rigid-bodies">Task analysis: Tracking the rigid bodies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pushrimkinetics.html">Wheelchair kinetics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">IN DEPTH</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lab_mode.html">Lab mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://felixchenier.uqam.ca/ktk_develop">Development website</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/felixchenier/kineticstoolkit">GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FOR DEVELOPERS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev/install.html">Installing from git-hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/conventions.html">Developer manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/tutorials.html">Tutorials for unreleased features</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kinetics Toolkit (dev)</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="kinematics.html">Kinematics analysis</a> &raquo;</li>
        
      <li>Reconstructing virtual markers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="../pushrimkinetics.html" class="btn btn-neutral float-right" title="Wheelchair kinetics" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      
      
        <a href="joint_angles.html" class="btn btn-neutral float-left" title="Calculating joint angles from a kinematic acquisition" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Reconstructing-virtual-markers">
<h1>Reconstructing virtual markers<a class="headerlink" href="#Reconstructing-virtual-markers" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial, we will reconstruct virtual markers for anatomic landmarks that were not physically instrumented during the movement acquisition. We usually do this kind of reconstruction when it is not practical or feasible to stick a marker on an anatomical landmark. Instead, we track rigid bodies affixed to the whole segment, and express the position of virtual markers relative to these rigid bodies.</p>
<p>This is a relatively complex process that requires these additional “calibration” acquisitions:</p>
<ol class="arabic simple">
<li><p>A static acquisition of a few seconds where we can see every marker.</p></li>
<li><p>Probing acquisitions, one for each virtual marker. In each of these acquisitions of a few seconds, we point the anatomical landmark using a calibrated probe. We need to see the probe’s markers and the markers of the rigid body affixed to the landmark’s segment.</p></li>
</ol>
<p>This analysis is composed of the following steps:</p>
<p><strong>Calibration steps:</strong></p>
<p><strong>Step 1.</strong> Define rigid body configurations (how are placed every markers one relative to the other on every rigid body);</p>
<p><strong>Step 2.</strong> Define virtual marker configurations (where are the anatomical landmarks relative to these rigid bodies);</p>
<p><strong>Task analysis steps:</strong></p>
<p><strong>Step 3.</strong> Reconstruct series of rigid body’s reference frames during the analyzed task (where are every segment and how are they oriented in space);</p>
<p><strong>Step 4.</strong> Reconstruct series of virtual markers during the analyzed tasks (where are the virtual markers relative to the segments’ rigid bodies).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">kineticstoolkit.lab</span> <span class="k">as</span> <span class="nn">ktk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="section" id="Read-and-visualize-marker-trajectories">
<h2>Read and visualize marker trajectories<a class="headerlink" href="#Read-and-visualize-marker-trajectories" title="Permalink to this headline">¶</a></h2>
<p>We proceed exactly as in the previous tutorials, but this time we will perform the analysis based on a minimal set of markers. Let’s say that for the right arm and forearm, all we have is one real marker on the lateral epicondyle, and two plates of three markers affixed to the arm and forearm segments (we will show every other in blue for easier visualization).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Read the markers</span>
<span class="n">markers</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">read_c3d_file</span><span class="p">(</span>
    <span class="n">ktk</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_folder</span> <span class="o">+</span> <span class="s1">&#39;/data/kinematics/sample_propulsion.c3d&#39;</span><span class="p">)</span>

<span class="c1"># Set every unnecessary markers to blue</span>
<span class="n">keep_white</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LateralEpicondyleR&#39;</span><span class="p">,</span> <span class="s1">&#39;ArmR1&#39;</span><span class="p">,</span> <span class="s1">&#39;ArmR2&#39;</span><span class="p">,</span> <span class="s1">&#39;ArmR3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ForearmR1&#39;</span><span class="p">,</span> <span class="s1">&#39;ForearmR2&#39;</span><span class="p">,</span> <span class="s1">&#39;ForearmR3&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">marker_name</span> <span class="ow">in</span> <span class="n">markers</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">marker_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_white</span><span class="p">:</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="n">markers</span><span class="o">.</span><span class="n">add_data_info</span><span class="p">(</span><span class="n">marker_name</span><span class="p">,</span> <span class="s1">&#39;Color&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="c1"># Set the point of view for 3D visualization</span>
<span class="n">viewing_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;zoom&#39;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
    <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="mf">0.16</span><span class="p">,</span>
    <span class="s1">&#39;translation&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Create the player</span>
<span class="n">player</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">Player</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span> <span class="o">**</span><span class="n">viewing_options</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="n">to_html5</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The aim of this tutorial is to reconstruct the right acromion, medial epicondyle and both styloids using static and probing acquisitions. Let’s begin.</p>
</div>
<div class="section" id="Calibration:-Defining-rigid-body-configurations-using-a-static-acquisition">
<h2>Calibration: Defining rigid body configurations using a static acquisition<a class="headerlink" href="#Calibration:-Defining-rigid-body-configurations-using-a-static-acquisition" title="Permalink to this headline">¶</a></h2>
<p>One of the aims of the static trial is to have a sample where every marker is visible. We use this trial to define the rigid body configuration. A rigid body configuration is a list of markers that form a rigid body, along with their local position in the rigid body’s reference frame.</p>
<p>For this example, we will create reference frames for the rigid bodies ‘ArmR’ and ‘ForearmR’.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rigid_body_definitions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="c1"># Read the static trial</span>
<span class="n">markers_static</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">read_c3d_file</span><span class="p">(</span>
    <span class="n">ktk</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_folder</span> <span class="o">+</span> <span class="s1">&#39;/data/kinematics/sample_static.c3d&#39;</span><span class="p">)</span>

<span class="c1"># Show this trial, just to inspect it</span>
<span class="n">player</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">Player</span><span class="p">(</span><span class="n">markers_static</span><span class="p">,</span> <span class="o">**</span><span class="n">viewing_options</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="n">to_html5</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop_time</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Using this trial, we now define a rigid body for the arm plate:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;ArmR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">define_rigid_body</span><span class="p">(</span>
    <span class="n">markers_static</span><span class="p">,</span>
    <span class="n">marker_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ArmR1&#39;</span><span class="p">,</span> <span class="s1">&#39;ArmR2&#39;</span><span class="p">,</span> <span class="s1">&#39;ArmR3&#39;</span><span class="p">])</span>

<span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;ArmR&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>We proceed the same way for the forearm:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;ForearmR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">define_rigid_body</span><span class="p">(</span>
    <span class="n">markers_static</span><span class="p">,</span>
    <span class="n">marker_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ForearmR1&#39;</span><span class="p">,</span> <span class="s1">&#39;ForearmR2&#39;</span><span class="p">,</span> <span class="s1">&#39;ForearmR3&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>For the probe, we will define its rigid body manually from its known specifications. Every 6 local point is expressed relative to a reference frame that is centered at the probe’s tip:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;Probe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Probe1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0021213</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0158328</span><span class="p">,</span> <span class="mf">0.0864285</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
    <span class="s1">&#39;Probe2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0021213</span><span class="p">,</span> <span class="mf">0.0158508</span><span class="p">,</span> <span class="mf">0.0864285</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
    <span class="s1">&#39;Probe3&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0020575</span><span class="p">,</span> <span class="mf">0.0160096</span><span class="p">,</span> <span class="mf">0.1309445</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
    <span class="s1">&#39;Probe4&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0021213</span><span class="p">,</span> <span class="mf">0.0161204</span><span class="p">,</span> <span class="mf">0.1754395</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
    <span class="s1">&#39;Probe5&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0017070</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0155780</span><span class="p">,</span> <span class="mf">0.1753805</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
    <span class="s1">&#39;Probe6&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.0017762</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0156057</span><span class="p">,</span> <span class="mf">0.1308888</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now that we created these rigid body configurations, we will be able to track these rigid bodies in every other acquisition. This process can be done using the <a class="reference internal" href="../api/kineticstoolkit.kinematics.track_rigid_body.html"><span class="doc">track_rigid_body()</span></a> function.</p>
<p>As an example, let’s see how we can track these rigid bodies in the static acquisition:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create a target TimeSeries</span>
<span class="n">rigid_bodies_static</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">TimeSeries</span><span class="p">()</span>

<span class="k">for</span> <span class="n">rigid_body_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ArmR&#39;</span><span class="p">,</span> <span class="s1">&#39;ForearmR&#39;</span><span class="p">]:</span>

    <span class="c1"># Track this rigid body</span>
    <span class="n">trajectory</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">track_rigid_body</span><span class="p">(</span>
        <span class="n">markers_static</span><span class="p">,</span>
        <span class="n">rigid_body_definition</span><span class="o">=</span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="n">rigid_body_name</span><span class="p">],</span>
        <span class="n">rigid_body_name</span><span class="o">=</span><span class="n">rigid_body_name</span>
    <span class="p">)</span>

    <span class="c1"># Add it to the target TimeSeries</span>
    <span class="n">rigid_bodies_static</span> <span class="o">=</span> <span class="n">rigid_bodies_static</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>

<span class="n">player</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">Player</span><span class="p">(</span><span class="n">markers_static</span><span class="p">,</span> <span class="n">rigid_bodies_static</span><span class="p">,</span> <span class="o">**</span><span class="n">viewing_options</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="n">to_html5</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop_time</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Calibration:-Defining-the-virtual-marker-configurations-based-on-probing-acquisitions">
<h2>Calibration: Defining the virtual marker configurations based on probing acquisitions<a class="headerlink" href="#Calibration:-Defining-the-virtual-marker-configurations-based-on-probing-acquisitions" title="Permalink to this headline">¶</a></h2>
<p>Now we will go though every probing acquisition and apply the same process on each acquisition:</p>
<ol class="arabic simple">
<li><p>Locate the probe and the segment’s rigid body using <a class="reference internal" href="../api/kineticstoolkit.kinematics.track_rigid_body.html"><span class="doc">track_rigid_body()</span></a>;</p></li>
<li><p>Express the tip of the probe in the segment’s local coordinate system;</p></li>
<li><p>Define a virtual marker based on the probe tip’s local position, using <a class="reference internal" href="../api/kineticstoolkit.kinematics.define_virtual_marker.html"><span class="doc">kinematics.define_virtual_marker()</span></a>.</p></li>
</ol>
<p>Since this is a repetitive operation, we will create a new function that will be called for each probing acquisition:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">process_probing_acquisition</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">rigid_body_name</span><span class="p">):</span>

    <span class="c1"># Load the markers</span>
    <span class="n">markers_probing</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">read_c3d_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

    <span class="c1"># Track the rigid body</span>
    <span class="n">rigid_bodies_probing</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">track_rigid_body</span><span class="p">(</span>
            <span class="n">markers_probing</span><span class="p">,</span>
            <span class="n">rigid_body_definition</span><span class="o">=</span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="n">rigid_body_name</span><span class="p">],</span>
            <span class="n">rigid_body_name</span><span class="o">=</span><span class="n">rigid_body_name</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Track the probe</span>
    <span class="n">rigid_bodies_probing</span> <span class="o">=</span> <span class="n">rigid_bodies_probing</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">track_rigid_body</span><span class="p">(</span>
            <span class="n">markers_probing</span><span class="p">,</span>
            <span class="n">rigid_body_definition</span><span class="o">=</span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;Probe&#39;</span><span class="p">],</span>
            <span class="n">rigid_body_name</span><span class="o">=</span><span class="s1">&#39;Probe&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Return the local coordinates of the probed virtual marker</span>
    <span class="k">return</span> <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">define_virtual_marker</span><span class="p">(</span>
        <span class="n">rigid_bodies_probing</span><span class="p">,</span>
        <span class="n">source_name</span><span class="o">=</span><span class="s1">&#39;Probe&#39;</span><span class="p">,</span>
        <span class="n">rigid_body_name</span><span class="o">=</span><span class="n">rigid_body_name</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now, we can process every probing acquisition.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;ArmR&#39;</span><span class="p">][</span><span class="s1">&#39;AcromionR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_probing_acquisition</span><span class="p">(</span>
    <span class="n">ktk</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_folder</span> <span class="o">+</span> <span class="s1">&#39;/data/kinematics/sample_probing_acromion_R.c3d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ArmR&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;ArmR&#39;</span><span class="p">][</span>
    <span class="s1">&#39;MedialEpicondyleR&#39;</span>
<span class="p">]</span> <span class="o">=</span> <span class="n">process_probing_acquisition</span><span class="p">(</span>
    <span class="n">ktk</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_folder</span>
    <span class="o">+</span> <span class="s1">&#39;/data/kinematics/sample_probing_medial_epicondyle_R.c3d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ArmR&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;ForearmR&#39;</span><span class="p">][</span>
    <span class="s1">&#39;RadialStyloidR&#39;</span>
<span class="p">]</span> <span class="o">=</span> <span class="n">process_probing_acquisition</span><span class="p">(</span>
    <span class="n">ktk</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_folder</span>
    <span class="o">+</span> <span class="s1">&#39;/data/kinematics/sample_probing_radial_styloid_R.c3d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ForearmR&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">rigid_body_definitions</span><span class="p">[</span><span class="s1">&#39;ForearmR&#39;</span><span class="p">][</span>
    <span class="s1">&#39;UlnarStyloidR&#39;</span>
<span class="p">]</span> <span class="o">=</span> <span class="n">process_probing_acquisition</span><span class="p">(</span>
    <span class="n">ktk</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">root_folder</span>
    <span class="o">+</span> <span class="s1">&#39;/data/kinematics/sample_probing_ulnar_styloid_R.c3d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ForearmR&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Task-analysis:-Tracking-the-rigid-bodies">
<h2>Task analysis: Tracking the rigid bodies<a class="headerlink" href="#Task-analysis:-Tracking-the-rigid-bodies" title="Permalink to this headline">¶</a></h2>
<p>Now that we defined the rigid bodies and the virtual markers, we are ready to process the experimental trial we loaded at the beginning of this tutorial. We already loaded the markers at the beginning of this tutorial. We will now track the rigid bodies. Since we added virtual markers to the rigid body definitions, we can use the <code class="docutils literal notranslate"><span class="pre">include_markers</span></code> option of <a class="reference internal" href="../api/kineticstoolkit.kinematics.track_rigid_body.html"><span class="doc">track_rigid_body()</span></a> to reconstruct every marker of this definition. This
generates both the rigid bodies’ local coordinate systems and the markers assigned to these rigid bodies.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rigid_bodies</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">TimeSeries</span><span class="p">()</span>

<span class="k">for</span> <span class="n">rigid_body_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ArmR&#39;</span><span class="p">,</span> <span class="s1">&#39;ForearmR&#39;</span><span class="p">]:</span>
    <span class="n">rigid_bodies</span> <span class="o">=</span> <span class="n">rigid_bodies</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">ktk</span><span class="o">.</span><span class="n">kinematics</span><span class="o">.</span><span class="n">track_rigid_body</span><span class="p">(</span>
            <span class="n">markers</span><span class="p">,</span>
            <span class="n">rigid_body_definition</span><span class="o">=</span><span class="n">rigid_body_definitions</span><span class="p">[</span><span class="n">rigid_body_name</span><span class="p">],</span>
            <span class="n">rigid_body_name</span><span class="o">=</span><span class="n">rigid_body_name</span><span class="p">,</span>
            <span class="n">include_markers</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># Show those rigid bodies and markers in a player</span>
<span class="n">player</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">Player</span><span class="p">(</span><span class="n">rigid_bodies</span><span class="p">,</span> <span class="o">**</span><span class="n">viewing_options</span><span class="p">)</span>

<span class="n">player</span><span class="o">.</span><span class="n">to_html5</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>That is it, we reconstructed the acromion, medial epicondyle and both styloids from probing acquisitions, without requiring physical markers on these landmarks. We can conclude by adding the segments for clearer visualization. From now one, we could continue our analysis and calculate the elbow angles as in the previous tutorial.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add the segments</span>
<span class="n">segments</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ArmR&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Color&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;Links&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;AcromionR&#39;</span><span class="p">,</span> <span class="s1">&#39;MedialEpicondyleR&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;AcromionR&#39;</span><span class="p">,</span> <span class="s1">&#39;LateralEpicondyleR&#39;</span><span class="p">]]</span>
    <span class="p">},</span>
    <span class="s1">&#39;ForearmR&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Color&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;Links&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;MedialEpicondyleR&#39;</span><span class="p">,</span> <span class="s1">&#39;RadialStyloidR&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;MedialEpicondyleR&#39;</span><span class="p">,</span> <span class="s1">&#39;UlnarStyloidR&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;LateralEpicondyleR&#39;</span><span class="p">,</span> <span class="s1">&#39;RadialStyloidR&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;LateralEpicondyleR&#39;</span><span class="p">,</span> <span class="s1">&#39;UlnarStyloidR&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;UlnarStyloidR&#39;</span><span class="p">,</span> <span class="s1">&#39;RadialStyloidR&#39;</span><span class="p">]]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">player</span> <span class="o">=</span> <span class="n">ktk</span><span class="o">.</span><span class="n">Player</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span> <span class="n">rigid_bodies</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="n">segments</span><span class="p">,</span> <span class="o">**</span><span class="n">viewing_options</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="n">to_html5</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For more information on kinematics, please check the <a class="reference internal" href="../api/kineticstoolkit.kinematics.html"><span class="doc">API Reference for the kinematics module</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../pushrimkinetics.html" class="btn btn-neutral float-right" title="Wheelchair kinetics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="joint_angles.html" class="btn btn-neutral float-left" title="Calculating joint angles from a kinematic acquisition" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-2021, Félix Chénier.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>